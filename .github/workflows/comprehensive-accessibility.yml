name: Comprehensive Web Accessibility Evaluation

on:
  schedule:
    # Run every Monday at 9:00 AM UTC (weekly)
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering
  
env:
  TARGET_URL: https://ncaa-d1-softball.netlify.app/
  
jobs:
  accessibility-audit:
    runs-on: ubuntu-latest
    name: Comprehensive Accessibility Audit
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install accessibility testing tools
        run: |
          npm install -g pa11y @axe-core/cli lighthouse puppeteer
          
      - name: Create reports directory
        run: mkdir -p accessibility-reports
        
      - name: Create pa11y configuration file
        run: |
          cat > pa11y.json << 'EOF'
          {
            "chromeLaunchConfig": {
              "args": [
                "--no-sandbox",
                "--disable-dev-shm-usage",
                "--disable-gpu",
                "--headless"
              ]
            },
            "timeout": 30000,
            "wait": 3000,
            "standard": "WCAG2AA",
            "runners": ["htmlcs"],
            "ignore": [
              "WCAG2AA.Principle1.Guideline1_4.1_4_3.G18.Fail"
            ]
          }
          EOF

      - name: Create keyboard navigation test script
        run: |
          cat > keyboard-test.js << 'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');

          async function testKeyboardNavigation() {
            const browser = await puppeteer.launch({
              headless: true,
              args: ['--no-sandbox', '--disable-dev-shm-usage']
            });
            
            const page = await browser.newPage();
            const issues = [];
            
            try {
              await page.goto(process.env.TARGET_URL, { waitUntil: 'networkidle0' });
              
              // Test tab navigation
              const focusableElements = await page.$$eval('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])', elements => {
                return elements.map(el => ({
                  tagName: el.tagName,
                  id: el.id,
                  className: el.className,
                  tabIndex: el.tabIndex
                }));
              });
              
              // Test each focusable element
              for (let i = 0; i < Math.min(focusableElements.length, 20); i++) {
                await page.keyboard.press('Tab');
                const activeElement = await page.evaluate(() => {
                  const el = document.activeElement;
                  return {
                    tagName: el.tagName,
                    id: el.id,
                    className: el.className,
                    hasVisibleFocus: window.getComputedStyle(el, ':focus').outline !== 'none'
                  };
                });
                
                if (!activeElement.hasVisibleFocus) {
                  issues.push({
                    type: 'keyboard-navigation',
                    severity: 'moderate',
                    message: `Element ${activeElement.tagName} lacks visible focus indicator`,
                    element: activeElement
                  });
                }
              }
              
              // Test Enter/Space key activation
              await page.keyboard.press('Tab');
              const buttonElements = await page.$$('button');
              if (buttonElements.length > 0) {
                const button = buttonElements[0];
                await button.focus();
                
                // Test if button responds to Enter key
                const enterResponse = await page.evaluate(() => {
                  return new Promise(resolve => {
                    const btn = document.activeElement;
                    let activated = false;
                    btn.addEventListener('click', () => { activated = true; });
                    btn.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
                    setTimeout(() => resolve(activated), 100);
                  });
                });
                
                if (!enterResponse) {
                  issues.push({
                    type: 'keyboard-navigation',
                    severity: 'serious',
                    message: 'Button does not respond to Enter key activation',
                    element: { tagName: 'BUTTON' }
                  });
                }
              }
              
            } catch (error) {
              issues.push({
                type: 'keyboard-navigation',
                severity: 'critical',
                message: `Keyboard navigation test failed: ${error.message}`,
                element: null
              });
            }
            
            await browser.close();
            
            fs.writeFileSync('accessibility-reports/keyboard-navigation.json', 
              JSON.stringify(issues, null, 2));
            
            return issues.length;
          }

          testKeyboardNavigation().then(count => {
            console.log(`Found ${count} keyboard navigation issues`);
            process.exit(0);
          }).catch(err => {
            console.error('Keyboard test error:', err);
            process.exit(1);
          });
          EOF

      - name: Create screen reader simulation script
        run: |
          cat > screen-reader-test.js << 'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');

          async function testScreenReaderCompatibility() {
            const browser = await puppeteer.launch({
              headless: true,
              args: ['--no-sandbox', '--disable-dev-shm-usage']
            });
            
            const page = await browser.newPage();
            const issues = [];
            
            try {
              await page.goto(process.env.TARGET_URL, { waitUntil: 'networkidle0' });
              
              // Test for missing alt text on images
              const imagesWithoutAlt = await page.$$eval('img', imgs => 
                imgs.filter(img => !img.alt || img.alt.trim() === '').length
              );
              
              if (imagesWithoutAlt > 0) {
                issues.push({
                  type: 'screen-reader',
                  severity: 'serious',
                  message: `${imagesWithoutAlt} images missing alt text`,
                  count: imagesWithoutAlt
                });
              }
              
              // Test for missing form labels
              const unlabeledInputs = await page.$$eval('input', inputs => 
                inputs.filter(input => {
                  const id = input.id;
                  const ariaLabel = input.getAttribute('aria-label');
                  const ariaLabelledby = input.getAttribute('aria-labelledby');
                  const hasLabel = id && document.querySelector(`label[for="${id}"]`);
                  return !hasLabel && !ariaLabel && !ariaLabelledby;
                }).length
              );
              
              if (unlabeledInputs > 0) {
                issues.push({
                  type: 'screen-reader',
                  severity: 'serious',
                  message: `${unlabeledInputs} form inputs missing labels`,
                  count: unlabeledInputs
                });
              }
              
              // Test for missing headings structure
              const headings = await page.$$eval('h1, h2, h3, h4, h5, h6', headings => 
                headings.map(h => ({ level: parseInt(h.tagName[1]), text: h.textContent.trim() }))
              );
              
              if (headings.length === 0) {
                issues.push({
                  type: 'screen-reader',
                  severity: 'moderate',
                  message: 'No heading structure found for screen reader navigation',
                  count: 1
                });
              } else {
                // Check for proper heading hierarchy
                let previousLevel = 0;
                for (const heading of headings) {
                  if (heading.level > previousLevel + 1) {
                    issues.push({
                      type: 'screen-reader',
                      severity: 'moderate',
                      message: `Heading hierarchy skip detected (h${previousLevel} to h${heading.level})`,
                      count: 1
                    });
                    break;
                  }
                  previousLevel = heading.level;
                }
              }
              
              // Test for missing ARIA landmarks
              const landmarks = await page.$$eval('[role="main"], [role="navigation"], [role="banner"], [role="contentinfo"], main, nav, header, footer', 
                elements => elements.length
              );
              
              if (landmarks === 0) {
                issues.push({
                  type: 'screen-reader',
                  severity: 'moderate',
                  message: 'No ARIA landmarks found for screen reader navigation',
                  count: 1
                });
              }
              
            } catch (error) {
              issues.push({
                type: 'screen-reader',
                severity: 'critical',
                message: `Screen reader test failed: ${error.message}`,
                count: 1
              });
            }
            
            await browser.close();
            
            fs.writeFileSync('accessibility-reports/screen-reader.json', 
              JSON.stringify(issues, null, 2));
            
            return issues.length;
          }

          testScreenReaderCompatibility().then(count => {
            console.log(`Found ${count} screen reader issues`);
            process.exit(0);
          }).catch(err => {
            console.error('Screen reader test error:', err);
            process.exit(1);
          });
          EOF
          
      - name: Run pa11y accessibility scan (HTML report)
        run: |
          echo "Running pa11y scan for HTML report..."
          echo "DEBUG: pa11y version:"
          pa11y --version
          echo "DEBUG: Target URL: $TARGET_URL"
          pa11y $TARGET_URL --reporter html --config pa11y.json > accessibility-reports/pa11y-report.html || true
          echo "DEBUG: pa11y HTML scan completed, checking file size:"
          ls -la accessibility-reports/pa11y-report.html || echo "HTML report not found"
          
      - name: Run pa11y accessibility scan (JSON report)
        run: |
          echo "Running pa11y scan for JSON report..."
          pa11y $TARGET_URL --reporter json --config pa11y.json --include-warnings --include-notices > accessibility-reports/pa11y-report.json || true
          echo "DEBUG: pa11y JSON scan completed, checking content:"
          echo "File size: $(wc -c < accessibility-reports/pa11y-report.json 2>/dev/null || echo '0') bytes"
          echo "First few lines of JSON:"
          head -5 accessibility-reports/pa11y-report.json 2>/dev/null || echo "JSON report not found or empty"
          
      - name: Run pa11y accessibility scan (CSV report)
        run: |
          echo "Running pa11y scan for CSV report..."
          pa11y $TARGET_URL --reporter csv --config pa11y.json --include-warnings --include-notices > accessibility-reports/pa11y-report.csv || true
          echo "DEBUG: pa11y CSV scan completed, checking content:"
          echo "File size: $(wc -c < accessibility-reports/pa11y-report.csv 2>/dev/null || echo '0') bytes"
          echo "CSV content preview:"
          head -3 accessibility-reports/pa11y-report.csv 2>/dev/null || echo "CSV report not found or empty"
          
      - name: Run axe-core accessibility scan
        run: |
          echo "Running axe-core scan..."
          npx axe $TARGET_URL \
            --save accessibility-reports/axe-report.json \
            --timeout 30000 \
            --chrome-options="no-sandbox,disable-dev-shm-usage" || true
            
      - name: Run Lighthouse accessibility audit
        run: |
          echo "Running Lighthouse accessibility audit..."
          lighthouse $TARGET_URL \
            --only-categories=accessibility \
            --output=json \
            --output-path=accessibility-reports/lighthouse-accessibility.report.json \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage" \
            --max-wait-for-load=30000 || true
            
      - name: Run Lighthouse accessibility audit (HTML report)
        run: |
          echo "Running Lighthouse accessibility audit (HTML)..."
          lighthouse $TARGET_URL \
            --only-categories=accessibility \
            --output=html \
            --output-path=accessibility-reports/lighthouse-accessibility \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage" \
            --max-wait-for-load=30000 || true
            
      - name: Run Lighthouse mobile accessibility audit
        run: |
          echo "Running Lighthouse mobile accessibility audit..."
          lighthouse $TARGET_URL \
            --only-categories=accessibility \
            --emulated-form-factor=mobile \
            --output=json \
            --output-path=accessibility-reports/lighthouse-accessibility-mobile.report.json \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage" \
            --max-wait-for-load=30000 || true

      - name: Run keyboard navigation tests
        run: |
          echo "Running keyboard navigation tests..."
          node keyboard-test.js || true

      - name: Run screen reader simulation tests
        run: |
          echo "Running screen reader simulation..."
          node screen-reader-test.js || true

      - name: Run screen reader simulation with axe-core
        run: |
          echo "Running screen reader simulation with axe-core..."
          npx axe $TARGET_URL \
            --save accessibility-reports/screenreader-simulation.json \
            --timeout 30000 \
            --chrome-options="no-sandbox,disable-dev-shm-usage" \
            --rules heading-order,landmark-one-main,aria-allowed-attr,aria-allowed-role || true

      - name: Generate comprehensive summary report
        run: |
          echo "# üõ†Ô∏è Accessibility Fix Guide" > accessibility-reports/README.md
          echo "" >> accessibility-reports/README.md
          echo "**Scan Date:** $(date)" >> accessibility-reports/README.md
          echo "**Target URL:** $TARGET_URL" >> accessibility-reports/README.md
          echo "**Standards:** WCAG 2.1 AA" >> accessibility-reports/README.md
          echo "" >> accessibility-reports/README.md
          
          # Initialize counters and arrays for prioritization
          CRITICAL_ISSUES=0
          HIGH_PRIORITY=0
          MEDIUM_PRIORITY=0
          LOW_PRIORITY=0
          
          echo "## üéØ Priority Action Plan" >> accessibility-reports/README.md
          echo "" >> accessibility-reports/README.md
          
          # Extract and prioritize axe-core violations (most reliable)
          if [ -f accessibility-reports/axe-report.json ]; then
            echo "### üö® Critical Issues (Fix First)" >> accessibility-reports/README.md
            echo "" >> accessibility-reports/README.md
            echo "These are WCAG violations that significantly impact user experience:" >> accessibility-reports/README.md
            echo "" >> accessibility-reports/README.md
            
            # Extract critical violations with specific fix guidance
            cat accessibility-reports/axe-report.json | jq -r '
              if type == "array" then .[0].violations else .violations end |
              .[] |
              "#### \(.id | gsub("-"; " ") | ascii_upcase)
              **Impact:** \(.impact // "Unknown")
              **Description:** \(.description)
              **How to fix:** \(.help)
              **Elements affected:** \(.nodes | length)
              **WCAG Reference:** \(.tags | map(select(test("wcag"))) | join(", "))
              
              "
            ' 2>/dev/null >> accessibility-reports/README.md || echo "Could not parse axe-core violations" >> accessibility-reports/README.md
            
            CRITICAL_ISSUES=$(cat accessibility-reports/axe-report.json | jq -r 'if type == "array" then .[0].violations else .violations end | length' 2>/dev/null || echo "0")
          fi
          
          # Extract Lighthouse structural issues
          if [ -f accessibility-reports/lighthouse-accessibility.report.json ]; then
            echo "### üèóÔ∏è Structural Issues (High Priority)" >> accessibility-reports/README.md
            echo "" >> accessibility-reports/README.md
            echo "These foundational issues affect screen reader navigation:" >> accessibility-reports/README.md
            echo "" >> accessibility-reports/README.md
            
            # Check for landmark-one-main
            if cat accessibility-reports/lighthouse-accessibility.report.json | jq -r '.audits["landmark-one-main"].scoreDisplayMode' | grep -q "notApplicable"; then
              echo "#### ADD MAIN LANDMARK" >> accessibility-reports/README.md
              echo "**Issue:** Your page lacks a \`<main>\` landmark" >> accessibility-reports/README.md
              echo "**Fix:** Wrap your primary content in a \`<main>\` element" >> accessibility-reports/README.md
              echo "\`\`\`jsx" >> accessibility-reports/README.md
              echo "// In your App.jsx:" >> accessibility-reports/README.md
              echo "<main>" >> accessibility-reports/README.md
              echo "  {/* Your main content components */}" >> accessibility-reports/README.md
              echo "  <StatLeaders />" >> accessibility-reports/README.md
              echo "  <TeamRankings />" >> accessibility-reports/README.md
              echo "  <TournamentBracket />" >> accessibility-reports/README.md
              echo "</main>" >> accessibility-reports/README.md
              echo "\`\`\`" >> accessibility-reports/README.md
              echo "" >> accessibility-reports/README.md
              HIGH_PRIORITY=$((HIGH_PRIORITY + 1))
            fi
            
            # Check for bypass navigation
            if cat accessibility-reports/lighthouse-accessibility.report.json | jq -r '.audits.bypass.scoreDisplayMode' | grep -q "notApplicable"; then
              echo "#### ADD SKIP NAVIGATION" >> accessibility-reports/README.md
              echo "**Issue:** No way for keyboard users to skip repetitive navigation" >> accessibility-reports/README.md
              echo "**Fix:** Add a skip link at the top of your page" >> accessibility-reports/README.md
              echo "\`\`\`jsx" >> accessibility-reports/README.md
              echo "// Add this as the first element in App.jsx:" >> accessibility-reports/README.md
              echo "<a href=\"#main-content\" className=\"skip-link\">" >> accessibility-reports/README.md
              echo "  Skip to main content" >> accessibility-reports/README.md
              echo "</a>" >> accessibility-reports/README.md
              echo "<main id=\"main-content\">" >> accessibility-reports/README.md
              echo "  {/* Your content */}" >> accessibility-reports/README.md
              echo "</main>" >> accessibility-reports/README.md
              echo "\`\`\`" >> accessibility-reports/README.md
              echo "" >> accessibility-reports/README.md
              echo "Add this CSS:" >> accessibility-reports/README.md
              echo "\`\`\`css" >> accessibility-reports/README.md
              echo ".skip-link {" >> accessibility-reports/README.md
              echo "  position: absolute;" >> accessibility-reports/README.md
              echo "  top: -40px;" >> accessibility-reports/README.md
              echo "  left: 6px;" >> accessibility-reports/README.md
              echo "  background: #000;" >> accessibility-reports/README.md
              echo "  color: #fff;" >> accessibility-reports/README.md
              echo "  padding: 8px;" >> accessibility-reports/README.md
              echo "  text-decoration: none;" >> accessibility-reports/README.md
              echo "  z-index: 1000;" >> accessibility-reports/README.md
              echo "}" >> accessibility-reports/README.md
              echo ".skip-link:focus { top: 6px; }" >> accessibility-reports/README.md
              echo "\`\`\`" >> accessibility-reports/README.md
              echo "" >> accessibility-reports/README.md
              HIGH_PRIORITY=$((HIGH_PRIORITY + 1))
            fi
          fi
          
          # Analyze pa11y issues for common patterns
          if [ -f accessibility-reports/pa11y-report.json ]; then
            PA11Y_COUNT=$(cat accessibility-reports/pa11y-report.json | jq '. | length' 2>/dev/null || echo "0")
            
            if [ "$PA11Y_COUNT" -gt "100" ]; then
              echo "### üìù Content Quality Issues (Medium Priority)" >> accessibility-reports/README.md
              echo "" >> accessibility-reports/README.md
              echo "**Found:** $PA11Y_COUNT content and markup issues" >> accessibility-reports/README.md
              echo "" >> accessibility-reports/README.md
              echo "**Common fixes needed:**" >> accessibility-reports/README.md
              echo "- Add \`alt\` attributes to images" >> accessibility-reports/README.md
              echo "- Ensure proper heading hierarchy (h1 ‚Üí h2 ‚Üí h3)" >> accessibility-reports/README.md
              echo "- Add labels to form inputs" >> accessibility-reports/README.md
              echo "- Improve color contrast ratios" >> accessibility-reports/README.md
              echo "" >> accessibility-reports/README.md
              echo "üìä **Detailed issues:** See \`pa11y-report.html\` for specific elements and locations" >> accessibility-reports/README.md
              echo "" >> accessibility-reports/README.md
              MEDIUM_PRIORITY=$PA11Y_COUNT
            fi
          fi
          
          # Summary and next steps
          TOTAL_ISSUES=$((CRITICAL_ISSUES + HIGH_PRIORITY + MEDIUM_PRIORITY))
          
          echo "## ‚úÖ Implementation Roadmap" >> accessibility-reports/README.md
          echo "" >> accessibility-reports/README.md
          echo "**Phase 1: Critical Fixes** (Est. 2-4 hours)" >> accessibility-reports/README.md
          echo "- Fix $CRITICAL_ISSUES WCAG violations (see above)" >> accessibility-reports/README.md
          echo "- Add main landmark and skip navigation ($HIGH_PRIORITY structural fixes)" >> accessibility-reports/README.md
          echo "" >> accessibility-reports/README.md
          echo "**Phase 2: Content Quality** (Est. 4-8 hours)" >> accessibility-reports/README.md
          echo "- Address $MEDIUM_PRIORITY content and markup issues" >> accessibility-reports/README.md
          echo "- Review pa11y-report.html for specific element fixes" >> accessibility-reports/README.md
          echo "" >> accessibility-reports/README.md
          echo "**Phase 3: Validation** (Est. 1-2 hours)" >> accessibility-reports/README.md
          echo "- Re-run accessibility scan" >> accessibility-reports/README.md
          echo "- Test with screen reader (NVDA or VoiceOver)" >> accessibility-reports/README.md
          echo "- Validate keyboard navigation" >> accessibility-reports/README.md
          echo "" >> accessibility-reports/README.md
          
          echo "## üîß Quick Component Fixes" >> accessibility-reports/README.md
          echo "" >> accessibility-reports/README.md
          echo "Based on your React components, here are likely needed updates:" >> accessibility-reports/README.md
          echo "" >> accessibility-reports/README.md
          echo "### App.jsx" >> accessibility-reports/README.md
          echo "- Wrap content in \`<main>\` element" >> accessibility-reports/README.md
          echo "- Add skip link for keyboard users" >> accessibility-reports/README.md
          echo "- Ensure proper page title" >> accessibility-reports/README.md
          echo "" >> accessibility-reports/README.md
          echo "### StatLeaders.jsx, TeamRankings.jsx, TournamentBracket.jsx" >> accessibility-reports/README.md
          echo "- Add proper heading structure (h2, h3)" >> accessibility-reports/README.md
          echo "- Ensure data tables have headers" >> accessibility-reports/README.md
          echo "- Add ARIA labels for complex widgets" >> accessibility-reports/README.md
          echo "" >> accessibility-reports/README.md
          echo "### Scoreboard.jsx" >> accessibility-reports/README.md
          echo "- Add live region for score updates" >> accessibility-reports/README.md
          echo "- Ensure proper labeling of interactive elements" >> accessibility-reports/README.md
          echo "" >> accessibility-reports/README.md
          
          echo "## üìö Resources" >> accessibility-reports/README.md
          echo "" >> accessibility-reports/README.md
          echo "- [React Accessibility Guide](https://react.dev/learn/accessibility)" >> accessibility-reports/README.md
          echo "- [WCAG 2.1 Quick Reference](https://www.w3.org/WAI/WCAG21/quickref/)" >> accessibility-reports/README.md
          echo "- [axe-react Development Tools](https://github.com/dequelabs/axe-core-npm/tree/develop/packages/react)" >> accessibility-reports/README.md
          echo "- [Screen Reader Testing Guide](https://webaim.org/articles/screenreader_testing/)" >> accessibility-reports/README.md
          
      - name: List generated reports
        run: |
          echo "Generated accessibility reports:"
          ls -la accessibility-reports/
          
      - name: Upload accessibility reports as baseline
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-evaluation
          path: accessibility-reports/
          retention-days: 90

      - name: Create baseline tracking metadata
        run: |
          cat > accessibility-reports/baseline-metadata.json << EOF
          {
            "scan_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow_run_id": "${{ github.run_id }}",
            "workflow_run_number": "${{ github.run_number }}",
            "repository": "${{ github.repository }}",
            "target_url": "$TARGET_URL",
            "commit_sha": "${{ github.sha }}",
            "baseline_established": true
          }
          EOF

      - name: Check if issues need to be created
        id: check_issues
        run: |
          # Calculate total issues found
          AXCORE_ISSUES=$(jq 'if type=="array" then .[0].violations else .violations end | length' accessibility-reports/axe-report.json 2>/dev/null || echo 0)
          PA11Y_ISSUES=$(jq 'length' accessibility-reports/pa11y-report.json 2>/dev/null || echo 0)
          KEYBOARD_ISSUES=$(jq 'length' accessibility-reports/keyboard-navigation.json 2>/dev/null || echo 0)
          SCREENREADER_ISSUES=$(jq 'length' accessibility-reports/screen-reader.json 2>/dev/null || echo 0)
          
          TOTAL_ISSUES=$((AXCORE_ISSUES + PA11Y_ISSUES + KEYBOARD_ISSUES + SCREENREADER_ISSUES))
          
          echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "axcore_issues=$AXCORE_ISSUES" >> $GITHUB_OUTPUT
          echo "pa11y_issues=$PA11Y_ISSUES" >> $GITHUB_OUTPUT
          echo "keyboard_issues=$KEYBOARD_ISSUES" >> $GITHUB_OUTPUT
          echo "screenreader_issues=$SCREENREADER_ISSUES" >> $GITHUB_OUTPUT

      - name: Create GitHub issue for Copilot
        if: steps.check_issues.outputs.total_issues > 0
        uses: actions/github-script@v7
        with:
          script: |
            const totalIssues = ${{ steps.check_issues.outputs.total_issues }};
            const axcoreIssues = ${{ steps.check_issues.outputs.axcore_issues }};
            const pa11yIssues = ${{ steps.check_issues.outputs.pa11y_issues }};
            const keyboardIssues = ${{ steps.check_issues.outputs.keyboard_issues }};
            const screenreaderIssues = ${{ steps.check_issues.outputs.screenreader_issues }};
            
            const issueBody = `
            ## üõ†Ô∏è Accessibility Issues Detected
            
            An automated accessibility scan identified **${totalIssues} total issues** that need to be addressed:
            
            ### Issue Breakdown:
            - **üö® Critical WCAG Violations**: ${axcoreIssues} issues (axe-core)
            - **üìù Content & Markup Issues**: ${pa11yIssues} issues (pa11y)
            - **‚å®Ô∏è Keyboard Navigation Issues**: ${keyboardIssues} issues
            - **üîä Screen Reader Issues**: ${screenreaderIssues} issues
            
            ### üìä Scan Details:
            - **Target URL**: ${process.env.TARGET_URL}
            - **Scan Date**: ${new Date().toISOString()}
            - **Workflow Run**: #${{ github.run_number }}
            - **Standards**: WCAG 2.1 AA compliance
            
            ### üéØ Priority Action Plan:
            
            1. **Fix Critical WCAG Violations** (${axcoreIssues} issues)
               - These impact users with disabilities immediately
               - Address semantic HTML, ARIA attributes, and landmarks
            
            2. **Improve Keyboard Navigation** (${keyboardIssues} issues)
               - Ensure all interactive elements are keyboard accessible
               - Add visible focus indicators
               - Test tab order and key activation
            
            3. **Enhance Screen Reader Support** (${screenreaderIssues} issues)
               - Fix heading hierarchy and landmarks
               - Add missing alt text and ARIA labels
               - Improve content structure
            
            4. **Address Content Issues** (${pa11yIssues} issues)
               - Fix color contrast and text legibility
               - Add proper form labels
               - Ensure semantic markup
            
            ### üìã Fix Instructions:
            
            Download the detailed reports from workflow run #${{ github.run_number }} artifact \`accessibility-evaluation.zip\` which contains:
            - \`axe-report.json\` - Specific WCAG violations with fix guidance
            - \`pa11y-report.html\` - Visual report with highlighted issues
            - \`keyboard-navigation.json\` - Keyboard accessibility problems
            - \`screen-reader.json\` - Screen reader compatibility issues
            - \`README.md\` - Comprehensive fix guide with code examples
            
            ### ‚è±Ô∏è Estimated Fix Time:
            - Critical issues: ~${Math.ceil(axcoreIssues * 15 / 60)} hours
            - Keyboard navigation: ~${Math.ceil(keyboardIssues * 20 / 60)} hours  
            - Screen reader fixes: ~${Math.ceil(screenreaderIssues * 20 / 60)} hours
            - Content issues: ~${Math.ceil(pa11yIssues * 10 / 60)} hours
            - **Total estimated time**: ~${Math.ceil((axcoreIssues * 15 + keyboardIssues * 20 + screenreaderIssues * 20 + pa11yIssues * 10) / 60)} hours
            
            ---
            
            @copilot please fix these accessibility issues by:
            1. Analyzing the detailed reports in the workflow artifacts
            2. Implementing the specific fixes identified in the axe-core and pa11y reports
            3. Adding proper keyboard navigation support
            4. Ensuring screen reader compatibility
            5. Testing your changes with the accessibility tools
            
            **Baseline Established**: This issue represents the baseline scan. When you complete the fixes, the post-merge workflow will measure your impact and calculate time saved.
            `;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üîß Accessibility scan found ${totalIssues} issues - Copilot fix requested (run #${{ github.run_number }})`,
              body: issueBody,
              labels: ['accessibility', 'copilot', 'automated-issue'],
              assignees: ['copilot-swe-agent']
            });
            
            // Store issue details for tracking
            require('fs').writeFileSync('accessibility-reports/github-issue.json', JSON.stringify({
              issue_number: issue.data.number,
              issue_url: issue.data.html_url,
              created_at: issue.data.created_at,
              baseline_run_id: '${{ github.run_id }}',
              baseline_run_number: '${{ github.run_number }}',
              total_issues: totalIssues,
              breakdown: {
                axcore_issues: axcoreIssues,
                pa11y_issues: pa11yIssues,
                keyboard_issues: keyboardIssues,
                screenreader_issues: screenreaderIssues
              }
            }, null, 2));
            
            console.log(`Created issue #${issue.data.number}: ${issue.data.html_url}`);

      # ...existing summary and upload steps...